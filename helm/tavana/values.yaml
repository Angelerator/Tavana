# Tavana Helm Chart Values - Community Edition
# Cloud-Agnostic Auto-Scaling DuckDB Query Platform

# Global settings
global:
  namespace: tavana
  # Container registry - GHCR for public, ACR for Azure (see values-azure.yaml)
  # NOTE: Some AKS clusters block external registries. Use ACR in those cases.
  imageRegistry: "ghcr.io/angelerator"
  imagePullPolicy: IfNotPresent
  imageTag: "latest"

# Image pull secrets (for private registries)
imagePullSecrets: []
  # - name: acr-secret
  # - name: dockerhub-secret

# Gateway settings
gateway:
  enabled: true
  replicaCount: 2
  image:
    repository: "tavana-gateway"
    tag: ""  # Defaults to global.imageTag
  
  # K8s 1.35+: In-place resource updates (VPA can resize without pod restart)
  # Enable this after upgrading to K8s 1.35+
  resizePolicy:
    enabled: false      # Set to true on K8s 1.35+
    cpu: "NotRequired"  # CPU can resize without restart
    memory: "RestartContainer"  # Memory resize requires container restart
  
  service:
    type: ClusterIP
    pgPort: 5432       # PostgreSQL wire protocol
    httpPort: 8080     # Health + Metrics
  
  # Arrow Flight SQL configuration (high-performance binary protocol)
  flightSql:
    enabled: true
    port: 9091         # Arrow Flight gRPC port (9091 allowed by Azure Policy)
  
  # TLS configuration for PostgreSQL wire protocol
  tls:
    # Enable TLS/SSL support (accepts both SSL and non-SSL connections)
    enabled: false
    # Self-signed certificate generation (for development/testing)
    selfSigned: true
    # Common name for self-signed certificate
    commonName: "tavana.local"
    # Use existing TLS secret instead of self-signed
    existingSecret: ""
    # Keys in the existing secret (PEM format)
    existingSecretCertKey: "tls.crt"
    existingSecretKeyKey: "tls.key"
  
  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "4Gi"
      cpu: "2000m"
  
  # Environment variables
  env: []
  
  # Liveness and readiness probes
  livenessProbe:
    enabled: true
    path: /health
    initialDelaySeconds: 30
    periodSeconds: 10
  readinessProbe:
    enabled: true
    path: /health
    initialDelaySeconds: 10
    periodSeconds: 5

# Worker settings (managed by gateway's smart scaler)
worker:
  enabled: true
  replicaCount: 2
  minReplicas: 2
  maxReplicas: 20
  image:
    repository: "tavana-worker"
    tag: ""  # Defaults to global.imageTag
  
  # K8s 1.35+: In-place resource updates (VPA can resize without pod restart)
  # Enable this after upgrading to K8s 1.35+
  resizePolicy:
    enabled: false      # Set to true on K8s 1.35+
    cpu: "NotRequired"  # CPU can resize without restart
    memory: "RestartContainer"  # Memory resize may require container restart
  
  # K8s 1.35+: Fine-grained restart rules for specific exit codes
  # Enable this after upgrading to K8s 1.35+
  restartPolicy:
    # Uncomment to enable on K8s 1.35+:
    # rules:
    #   - exitCodes: [137]     # OOMKilled
    #     action: Restart
    #   - exitCodes: [143]     # SIGTERM
    #     action: Restart
    #   - exitCodes: [1]       # General error
    #     action: Restart
    #     maxRestarts: 3
    rules: []
  
  resources:
    requests:
      memory: "4Gi"
      cpu: "500m"
    limits:
      memory: "16Gi"
      cpu: "4"
  
  # Environment variables
  env: []
  
  # Node selector for dedicated worker nodes
  nodeSelector: {}
    # nodepool: tavana
  
  # Tolerations for dedicated worker nodes
  tolerations: []
    # - key: "workload"
    #   operator: "Equal"
    #   value: "tavana"
    #   effect: "NoSchedule"

# Horizontal Pod Autoscaler
hpa:
  enabled: true
  minReplicas: 2
  maxReplicas: 20
  cpuTargetUtilization: 70
  memoryTargetUtilization: 80
  # Custom metrics (requires metrics-server and prometheus-adapter)
  queueDepthTarget: "5"
  queueWaitTimeSecondsTarget: "30s"
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      # K8s 1.35+: Custom tolerance for more responsive scaling
      # Default is 0.1 (10%). Set to 0.05 for 5% sensitivity.
      # Uncomment after upgrading to K8s 1.35+:
      # tolerance: 0.05
      policies:
        - type: Pods
          value: 2
          periodSeconds: 60
    scaleDown:
      stabilizationWindowSeconds: 300
      # K8s 1.35+: Custom tolerance for scale-down decisions
      # Uncomment after upgrading to K8s 1.35+:
      # tolerance: 0.1
      policies:
        - type: Pods
          value: 1
          periodSeconds: 120

# Vertical Pod Autoscaler
vpa:
  enabled: true
  gateway:
    updateMode: "Auto"
    minCpu: "100m"
    minMemory: "512Mi"
    maxCpu: "4"
    maxMemory: "8Gi"
  worker:
    updateMode: "Auto"
    minCpu: "250m"
    minMemory: "2Gi"
    maxCpu: "8"
    maxMemory: "32Gi"

# Pod Disruption Budgets
pdb:
  enabled: true
  gateway:
    minAvailable: 1
  worker:
    minAvailable: 2

# Object Storage (S3-compatible)
objectStorage:
  # Endpoint for S3-compatible storage
  endpoint: ""
  # Bucket name for data
  bucket: ""
  # Region (for AWS S3)
  region: "us-east-1"
  # Use path-style access (required for MinIO, ADLS with S3 API)
  pathStyle: true
  # Credentials (use existingSecret in production)
  accessKeyId: ""
  secretAccessKey: ""
  existingSecret: ""
  existingSecretAccessKeyIdKey: "access-key-id"
  existingSecretSecretAccessKeyKey: "secret-access-key"

# Service Account
serviceAccount:
  create: true
  name: "tavana"
  annotations: {}
  # AWS IRSA annotation:
  # eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT:role/tavana-role
  # Azure Workload Identity annotation:
  # azure.workload.identity/client-id: CLIENT_ID

# Pod Security
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  seccompProfile:
    type: RuntimeDefault

containerSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL

# Network Policies
networkPolicies:
  enabled: true

# Ingress configuration
ingress:
  enabled: false
  className: ""
  annotations: {}
  hosts:
    - host: tavana.example.com
      paths:
        - path: /
          pathType: Prefix
  tls: []

# Monitoring
monitoring:
  prometheus:
    enabled: true
    serviceMonitor:
      enabled: false
      namespace: ""
      labels: {}

# =============================================================================
# Authentication Gateway Configuration
# =============================================================================
# Tavana supports multiple authentication modes and providers.
# Auth is OPTIONAL - community editions can run without any auth.
#
# Modes:
#   - passthrough: No auth required (default for community edition)
#   - required:    Auth required via configured providers
#   - optional:    Allow anonymous if no credentials provided
#
# Providers (can enable multiple):
#   - separ:       Centralized authorization platform (enterprise)
#   - jwt:         Direct JWT/OIDC validation (any IdP)
#   - staticKeys:  Simple API key authentication
#
auth:
  # Auth mode - "passthrough" for community/dev, "required" for enterprise
  mode: "passthrough"
  
  # --- Provider 1: Separ (Enterprise Authorization Platform) ---
  # Enable for centralized multi-tenant authorization
  separ:
    enabled: false
    endpoint: "http://separ.separ.svc.cluster.local:8080"
    enableAuthz: true
    tenantExtraction: "email_domain"  # email_domain, backslash_prefix, none
    existingSecret: ""                 # K8s secret with API key
    existingSecretKey: "separ-api-key"
    # Connection tuning
    connectTimeoutMs: 5000
    requestTimeoutMs: 10000
    poolIdleTimeoutSecs: 90
    poolMaxIdlePerHost: 10
  
  # --- Provider 2: Direct JWT/OIDC (Any Identity Provider) ---
  # Enable for direct JWT validation without Separ
  # Works with: Azure AD, Okta, Auth0, Keycloak, etc.
  jwt:
    enabled: false
    # issuer: "https://your-idp.example.com"
    # audience: "tavana"
    # algorithm: "RS256"  # RS256 for asymmetric, HS256 for symmetric
    # jwksUri: "https://your-idp.example.com/.well-known/jwks.json"
    # secretOrKeyPath: ""  # For HS256 or local public key
    # clockSkewSecs: 60
  
  # --- Provider 3: Static API Keys ---
  # Enable for simple service-to-service auth
  staticKeys:
    enabled: false
    # keys: []  # Define via secrets, not inline
  
  # --- Auth Caching ---
  cache:
    enabled: true
    ttlSecs: 300        # Cache successful auth for 5 minutes
    maxSize: 10000      # Max cached entries
  
  # --- Rate Limiting ---
  rateLimit:
    enabled: true
    maxFailedAttempts: 5
    banDurationSecs: 300

# ConfigMap for gateway configuration
config:
  # Log level: debug, info, warn, error
  logLevel: "info"
  # Worker discovery endpoint
  workerServiceName: "worker"
  workerServicePort: 50053

# RBAC for gateway to manage workers
rbac:
  create: true

# Pod Disruption Budgets
podDisruptionBudget:
  gateway:
    enabled: true
    minAvailable: 1
  worker:
    enabled: true
    maxUnavailable: 1
