# Tavana Helm Chart - Azure Values Template
# Cloud-Agnostic Auto-Scaling DuckDB Query Platform
#
# This file provides Azure-specific defaults. Copy and customize for your environment:
#   cp values-azure.yaml my-values.yaml
#   # Edit my-values.yaml with your settings
#   helm install tavana ./helm/tavana -f my-values.yaml

# Global settings
global:
  namespace: tavana
  # Container registry - use your private ACR
  # Example: myacr.azurecr.io
  imageRegistry: ""  # REQUIRED: Set to your ACR login server
  imagePullPolicy: Always
  imageTag: "v1.0.0"

# Private registry credentials
# Create with: kubectl create secret docker-registry acr-secret --docker-server=... -n tavana
imagePullSecrets:
  - name: acr-secret

# Gateway configuration
gateway:
  enabled: true
  replicaCount: 2
  image:
    repository: tavana-gateway
  
  service:
    type: ClusterIP
    pgPort: 15432
    httpPort: 8080
  
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "2Gi"
      cpu: "1000m"

# Worker configuration
worker:
  enabled: true
  replicaCount: 2
  minReplicas: 2
  maxReplicas: 20
  image:
    repository: tavana-worker
  
  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "8Gi"
      cpu: "4000m"

# HPA configuration
hpa:
  enabled: true
  minReplicas: 2
  maxReplicas: 20
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Azure Blob Storage / ADLS Gen2 (S3-compatible API)
# Option 1: Storage account with hierarchical namespace (ADLS Gen2)
# Option 2: Azure Blob with S3 compatibility layer
objectStorage:
  # Storage endpoint (leave empty to use Azure SDK with Workload Identity)
  endpoint: ""
  bucket: ""
  region: "westeurope"
  pathStyle: false
  # Use Kubernetes secret for credentials
  existingSecret: ""
  existingSecretAccessKeyIdKey: "storage-account-name"
  existingSecretSecretAccessKeyKey: "storage-account-key"

# Service Account with Azure Workload Identity
serviceAccount:
  create: true
  name: "tavana"
  annotations:
    # Azure Workload Identity - set your managed identity client ID
    azure.workload.identity/client-id: ""

# Pod labels for Workload Identity
podLabels:
  azure.workload.identity/use: "true"

# Security (Azure Policy / PSS compliant)
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  seccompProfile:
    type: RuntimeDefault

containerSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL

# Network Policies
networkPolicies:
  enabled: true
  # Azure service CIDRs - customize for your region
  # Find your region's CIDRs: https://azureipranges.azurewebsites.net/
  egressCIDRs:
    - 10.0.0.0/8         # Private network (VNet)
    - 100.64.0.0/10      # Azure Private Link
    - 168.63.0.0/16      # Azure platform services

# Ingress via Azure Application Gateway (AGIC)
ingress:
  enabled: true
  className: "azure/application-gateway"
  annotations:
    appgw.ingress.kubernetes.io/ssl-redirect: "true"
    appgw.ingress.kubernetes.io/connection-draining: "true"
    appgw.ingress.kubernetes.io/connection-draining-timeout: "30"
    appgw.ingress.kubernetes.io/request-timeout: "300"
    appgw.ingress.kubernetes.io/backend-protocol: "http"
    appgw.ingress.kubernetes.io/health-probe-path: "/health"
  hosts:
    - host: ""  # REQUIRED: Set your hostname (e.g., tavana.example.com)
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: tavana-tls
      hosts:
        - ""  # REQUIRED: Same as hosts[0].host

# Monitoring
monitoring:
  prometheus:
    enabled: false
    serviceMonitor:
      enabled: false

# RBAC
rbac:
  create: true

# Pod Disruption Budgets
podDisruptionBudget:
  gateway:
    enabled: true
    minAvailable: 1
  worker:
    enabled: true
    maxUnavailable: 1
