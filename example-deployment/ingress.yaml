# Customer Tavana Deployment - Private Ingress Configuration
# Uses Azure Application Gateway Ingress Controller (AGIC) with private IP only
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: tavana-ingress
  namespace: tavana-local
  labels:
    app: tavana
    app.kubernetes.io/name: tavana
    app.kubernetes.io/instance: tavana-local
    app.kubernetes.io/component: ingress
    app.kubernetes.io/managed-by: Helm
    environment: dev
    project: patenting
  annotations:
    kubernetes.io/ingress.class: azure/application-gateway
    # CRITICAL: Use private IP only - NO public exposure
    appgw.ingress.kubernetes.io/use-private-ip: "true"
    # SSL configuration - use App Gateway managed certificate
    appgw.ingress.kubernetes.io/appgw-ssl-certificate: cert-tavana-local-ssl
    appgw.ingress.kubernetes.io/ssl-redirect: "true"
    # Backend protocol - Gateway accepts plain TCP for PostgreSQL
    appgw.ingress.kubernetes.io/backend-protocol: tcp
    # Health probe configuration
    appgw.ingress.kubernetes.io/health-probe-path: /health
    appgw.ingress.kubernetes.io/health-probe-interval: "30"
    appgw.ingress.kubernetes.io/health-probe-timeout: "5"
    appgw.ingress.kubernetes.io/health-probe-unhealthy-threshold: "3"
    # Connection settings for long-running queries
    appgw.ingress.kubernetes.io/connection-draining: "true"
    appgw.ingress.kubernetes.io/connection-draining-timeout: "300"
    appgw.ingress.kubernetes.io/request-timeout: "600"
spec:
  tls:
  - hosts:
    - tavana.example.com
  rules:
  - host: tavana.example.com
    http:
      paths:
      # PostgreSQL wire protocol (primary)
      - path: /
        pathType: Prefix
        backend:
          service:
            name: tavana-gateway
            port:
              number: 5432
---
# Alternative: Direct TCP LoadBalancer for PostgreSQL (internal only)
# Use this if App Gateway doesn't support TCP passthrough
apiVersion: v1
kind: Service
metadata:
  name: tavana-gateway-internal-lb
  namespace: tavana-local
  labels:
    app: tavana-gateway
    app.kubernetes.io/name: tavana
    app.kubernetes.io/instance: tavana-local
    app.kubernetes.io/component: gateway
    app.kubernetes.io/managed-by: Helm
    environment: dev
    project: patenting
  annotations:
    # CRITICAL: Internal load balancer only - NO public IP
    service.beta.kubernetes.io/azure-load-balancer-internal: "true"
    # Use the same subnet as the AKS nodes
    service.beta.kubernetes.io/azure-load-balancer-internal-subnet: "tech-nprd-patb-aks-nodepool-subnet"
spec:
  type: LoadBalancer
  selector:
    app: tavana-gateway
  ports:
  - name: pg
    port: 5432
    targetPort: 5432
    protocol: TCP
  - name: http
    port: 8080
    targetPort: 8080
    protocol: TCP

